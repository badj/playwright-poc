name: JMeter Performance Tests in Docker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '30 19 * * *'  # 7:30 am NZT (UTC+12)
  workflow_dispatch:  # Allows manual trigger

jobs:
  load-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'  # JMeter compatible

      - name: Download JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          mv apache-jmeter-5.6.3 jmeter

      - name: Run JMeter Performance Tests in Docker
        run: |
          ./jmeter/bin/jmeter -n -t performance-tests/load-test.jmx -l results.jtl -e -o dashboard

      - name: Upload JMeter Test Results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: |
            results.jtl
            dashboard/

      - name: Analyze JMeter Test Results
        run: |
          echo "Summary:"
          if [ -f dashboard/content/js/dashboard.js ]; then
#             Collapse newlines to spaces, clean up extra spaces, and extract the summary object
            SUMMARY=$(cat dashboard/content/js/dashboard.js | tr '\n' ' ' | sed 's/  */ /g' | grep -oP 'summary = \K\{[^}]*\}')
            if [ -n "$SUMMARY" ]; then
              echo "$SUMMARY"
            else
              echo "No summary data found in dashboard (extraction failed; check if multiline or empty)."
              echo "Checking results.jtl for data..."
              if [ -f results.jtl ]; then
                LINE_COUNT=$(wc -l < results.jtl)
                echo "results.jtl has $LINE_COUNT lines."
                if [ "$LINE_COUNT" -le 1 ]; then
                  echo "No test samples executed (only header in results.jtl). Verify load-test.jmx has valid samplers and runs successfully."
                else
#                   Optionally extract basic metrics from results.jtl (e.g., error count)
                  ERROR_COUNT=$(grep -c ',false,' results.jtl)
                  echo "Detected $ERROR_COUNT errors in results."
                fi
              else
                echo "No results file found."
                exit 1
              fi
            fi
          else
            echo "Dashboard not generated. Checking results.jtl..."
            if [ -f results.jtl ]; then
              wc -l results.jtl
            else
              echo "No results file found."
              exit 1
            fi
          fi
