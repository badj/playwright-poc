name: JMeter Performance Tests in Docker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '30 19 * * *'  # 7:30 am NZT (UTC+12)
  workflow_dispatch:  # Allows manual trigger

jobs:
  load-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'  # JMeter compatible

      - name: Download JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          mv apache-jmeter-5.6.3 jmeter

      - name: Run JMeter Performance Tests in Docker
        run: |
          ./jmeter/bin/jmeter -n -t performance-tests/load-test.jmx -l results.jtl -e -o dashboard

      - name: Upload JMeter Test Results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: |
            results.jtl
            dashboard/

      - name: Analyze JMeter Test Results
        run: |
          echo "=== JMeter Test Results Analysis ==="
          echo ""
          
          if [ ! -f results.jtl ]; then
            echo "‚ùå Error: results.jtl not found!"
            exit 1
          fi
          
          # Count total samples (excluding header)
          TOTAL_SAMPLES=$(tail -n +2 results.jtl | wc -l)
          
          if [ "$TOTAL_SAMPLES" -eq 0 ]; then
            echo "‚ùå No test samples executed. Verify load-test.jmx has valid samplers."
            exit 1
          fi
          
          echo "üìä Total Samples: $TOTAL_SAMPLES"
          
          # Count errors (lines with ",false," in success column)
          ERROR_COUNT=$(tail -n +2 results.jtl | grep -c ',false,' || true)
          SUCCESS_COUNT=$((TOTAL_SAMPLES - ERROR_COUNT))
          SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($SUCCESS_COUNT/$TOTAL_SAMPLES)*100}")
          
          echo "‚úÖ Successful: $SUCCESS_COUNT ($SUCCESS_RATE%)"
          echo "‚ùå Failed: $ERROR_COUNT"
          
          # Calculate response time statistics (column 2 is elapsed time in ms)
          echo ""
          echo "‚è±Ô∏è  Response Time Statistics (ms):"
          tail -n +2 results.jtl | awk -F',' '{print $2}' | sort -n | awk '
            BEGIN { min=999999; max=0; sum=0; count=0 }
            {
              sum+=$1; 
              count++; 
              if($1<min) min=$1; 
              if($1>max) max=$1;
              times[count]=$1
            }
            END {
              avg=sum/count;
              # Calculate median
              if(count%2==1) median=times[int(count/2)+1];
              else median=(times[int(count/2)]+times[int(count/2)+1])/2;
              # Calculate 90th percentile
              p90_idx=int(count*0.9);
              p90=times[p90_idx];
              # Calculate 95th percentile
              p95_idx=int(count*0.95);
              p95=times[p95_idx];
          
              printf "  Min:     %d ms\n", min;
              printf "  Average: %.0f ms\n", avg;
              printf "  Median:  %.0f ms\n", median;
              printf "  90th %%:  %d ms\n", p90;
              printf "  95th %%:  %d ms\n", p95;
              printf "  Max:     %d ms\n", max;
            }'
          
          # Calculate throughput
          echo ""
          echo "üöÄ Throughput:"
          START_TIME=$(tail -n +2 results.jtl | head -1 | awk -F',' '{print $1}')
          END_TIME=$(tail -n +2 results.jtl | tail -1 | awk -F',' '{print $1}')
          DURATION=$((($END_TIME - $START_TIME) / 1000))
          
          if [ "$DURATION" -gt 0 ]; then
            THROUGHPUT=$(awk "BEGIN {printf \"%.2f\", $TOTAL_SAMPLES/$DURATION}")
            echo "  Requests/sec: $THROUGHPUT"
            echo "  Duration: ${DURATION}s"
          fi
          
          # Show error details if any
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  Error Details:"
            tail -n +2 results.jtl | grep ',false,' | awk -F',' '{print "  - " $3 ": " $4}' | head -10
            if [ "$ERROR_COUNT" -gt 10 ]; then
              echo "  ... and $((ERROR_COUNT - 10)) more errors"
            fi
          fi
          
          # Check if dashboard was generated
          echo ""
          if [ -d dashboard ]; then
            echo "üìà HTML Dashboard generated at: dashboard/index.html"
          else
            echo "‚ö†Ô∏è  Dashboard directory not found"
          fi
          
          echo ""
          echo "=== Analysis Complete ==="
